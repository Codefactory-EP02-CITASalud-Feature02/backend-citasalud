# ==============================================================================
# Definición del Esquema Principal de GraphQL (schema.graphqls)
# ==============================================================================

# --- INPUTS ---

# Input para la mutación de Autenticación.
input AuthInput {
    email: String!
    contrasena: String!
}

# Input para la mutación de Agendamiento (SEGURO).
# El usuarioId NO se incluye; se obtiene del token JWT para prevenir suplantación.
input AgendamientoInput {
    sedeId: ID!
    examenId: ID!
    fechaHora: String! # Debe ser un String en formato ISO 8601 (YYYY-MM-DDTHH:MM:SS)
}

# Input para la mutación de Cancelacion (SEGURO).
# El usuarioId NO se incluye; se obtiene del token JWT para prevenir suplantación.
input CancelacionInput {
    citaId: ID!
    motivo: String
}

# Input para la mutación de actualizar el perfil del paciente
input ActualizarPerfilInput {
    nombre: String
    apellido: String
    tipoDocumento: String # Respetando tu entidad
    numeroDocumento: String
    telefono: String
    email: String
}

# --- QUERIES (Consultas) ---

type Query {
    # Placeholder o consulta mínima.
    _dummy: String

    # Consultas de disponibilidad (Públicas)
    fechasDisponibles: [String!]!

    # Corregido: sedeId debe ser ID! (Long)
    sedesDisponibles(fecha: String!): [Sede!]!

    # Corregido: sedeId y tipoExamenId deben ser ID! (Long)
    tiposExamenDisponibles(fecha: String!, sedeId: ID!): [TipoExamen!]!

    # Corregido: Todos los IDs deben ser ID! (Long)
    examenesDisponibles(fecha: String!, sedeId: ID!, tipoExamenId: ID!): [Examen!]!
    # Devuelve las citas del usuario autenticado (usa el userId del token)
    misCitas: [CitaExamen!]!

    # Query de perfil
    miPerfil: Usuario!
}

# --- MUTATIONS (Modificaciones de Estado) ---

type Mutation {
    # Autentica un usuario usando el AuthInput.
    login(input: AuthInput!): AuthResponse # Corregido para usar el input único

    # Agenda un examen. Protegido con Spring Security (@PreAuthorize).
    agendarExamen(input: AgendamientoInput!): CitaExamen!

    #Cancela una cita. Protegido con Spring Security (@PreAuthorize).
    cancelarExamen(input: CancelacionInput!): CitaExamen!

    # Mutation Actualizar perfil
    actualizarPerfil(input: ActualizarPerfilInput!): Usuario!
}

# --- TIPOS DE RESPUESTA (Output Types) ---
# 1. Se define el Enum que corresponde a EstadoCita.java
#    Esto permite al frontend saber exactamente qué estados son válidos.
enum EstadoCita {
    PENDIENTE,
    CONFIRMADO,
    CANCELADO,
    REQUIERE_DOCUMENTOS,
    REGISTRADO_EN_SEDE,
    COMPLETADO,
    NO_SE_PRESENTO
}

type AuthResponse {
    token: String!
}

type Sede {
    id: ID!
    nombre: String
    direccion: String
}

type TipoExamen {
    id: ID!
    nombre: String
}

type Examen {
    id: ID!
    nombre: String
    preparacionRequerida: String
}

type CitaExamen {

    idCita: ID!
    fechaHora: String
    estado: EstadoCita!
    fechaModificacion: String!
    examen: Examen
    sede: Sede
    motivoCancelacion: String
}

type Usuario {
    idUsuario: ID!
    nombre: String!
    apellido: String!
    tipoDocumento: String!
    numeroDocumento: String!
    email: String!
    telefono: String!
    fechaNacimiento: String! # Formato ISO 8601 (YYYY-MM-DD)
    # NO incluir contrasena por seguridad
    # roles: [Rol!]! # Descomentar si necesitas exponer los roles
}