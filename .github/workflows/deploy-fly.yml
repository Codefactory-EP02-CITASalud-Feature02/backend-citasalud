name: Deploy to Fly

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy backend to Fly
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Authenticate to Fly (uses FLY_API_TOKEN secret)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -z "$FLY_API_TOKEN" ]; then
            echo "FLY_API_TOKEN is not set. Add it to repository secrets to enable deploy.";
            exit 1;
          fi
          # Non-interactive login to Fly using the token from GitHub Secrets
          flyctl auth login --access-token "$FLY_API_TOKEN"
          # Print authenticated account to the log so we can confirm (logs are masked for secrets)
          flyctl auth whoami

      - name: Set Fly secrets (if provided in GitHub Secrets)
        env:
          SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          APP_JWTSECRET: ${{ secrets.APP_JWTSECRET }}
          APP_JWT_EXPIRATION_MS: ${{ secrets.APP_JWT_EXPIRATION_MS }}
        run: |
          # Only set secrets if values are present. GitHub will mask secrets in logs.
          if [ -n "$SPRING_DATASOURCE_URL" ]; then
            echo "Setting Fly secrets from repository secrets..."
            flyctl secrets set \
              SPRING_DATASOURCE_URL="$SPRING_DATASOURCE_URL" \
              SPRING_DATASOURCE_USERNAME="$SPRING_DATASOURCE_USERNAME" \
              SPRING_DATASOURCE_PASSWORD="$SPRING_DATASOURCE_PASSWORD" \
              APP_JWTSECRET="$APP_JWTSECRET" \
              APP_JWT_EXPIRATION_MS="$APP_JWT_EXPIRATION_MS"
          else
            echo "No DB secrets provided in GitHub Secrets; skipping flyctl secrets set."
          fi

      - name: Deploy to Fly (remote build)
        run: |
          # Use remote-only to let Fly build the image on their builders using your repo
          flyctl deploy --remote-only --config fly.toml
